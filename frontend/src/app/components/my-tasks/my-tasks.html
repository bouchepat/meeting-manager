<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="mb-1">My Tasks</h2>
      <p class="text-muted mb-0">Tasks assigned to you from meeting action items</p>
    </div>
    <button class="btn btn-outline-primary" (click)="loadTasks(true)">
      <i class="bi bi-arrow-clockwise me-1"></i>
      Refresh
    </button>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading()" class="text-center py-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-3 text-muted">Loading your tasks...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error()" class="alert alert-danger" role="alert">
    <i class="bi bi-exclamation-triangle-fill me-2"></i>
    {{ error() }}
  </div>

  <!-- Content -->
  <div *ngIf="!isLoading() && !error()">
    <!-- Filter Tabs -->
    <ul class="nav nav-pills mb-4">
      <li class="nav-item">
        <button
          class="nav-link"
          [class.active]="statusFilter() === 'all'"
          (click)="setStatusFilter('all')">
          All
          <span class="badge bg-secondary ms-1">{{ taskCounts().all }}</span>
        </button>
      </li>
      <li class="nav-item">
        <button
          class="nav-link"
          [class.active]="statusFilter() === TaskStatus.TODO"
          (click)="setStatusFilter(TaskStatus.TODO)">
          To Do
          <span class="badge bg-secondary ms-1">{{ taskCounts().todo }}</span>
        </button>
      </li>
      <li class="nav-item">
        <button
          class="nav-link"
          [class.active]="statusFilter() === TaskStatus.IN_PROGRESS"
          (click)="setStatusFilter(TaskStatus.IN_PROGRESS)">
          In Progress
          <span class="badge bg-primary ms-1">{{ taskCounts().inProgress }}</span>
        </button>
      </li>
      <li class="nav-item">
        <button
          class="nav-link"
          [class.active]="statusFilter() === TaskStatus.DONE"
          (click)="setStatusFilter(TaskStatus.DONE)">
          Done
          <span class="badge bg-success ms-1">{{ taskCounts().done }}</span>
        </button>
      </li>
    </ul>

    <!-- Search -->
    <div class="input-group mb-4">
      <span class="input-group-text">
        <i class="bi bi-search"></i>
      </span>
      <input
        type="text"
        class="form-control"
        placeholder="Search tasks..."
        [(ngModel)]="searchQuery"
        (input)="searchQuery.set($any($event.target).value)">
      <button
        *ngIf="searchQuery()"
        class="btn btn-outline-secondary"
        type="button"
        (click)="clearSearch()">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>

    <!-- No Tasks -->
    <div *ngIf="tasks().length === 0" class="text-center py-5">
      <i class="bi bi-clipboard-check display-1 text-muted"></i>
      <h4 class="mt-4">No tasks assigned to you</h4>
      <p class="text-muted">Tasks will appear here when you're assigned action items from meetings</p>
    </div>

    <!-- No Filtered Results -->
    <div *ngIf="tasks().length > 0 && filteredTasks().length === 0" class="text-center py-5">
      <i class="bi bi-funnel display-4 text-muted"></i>
      <h5 class="mt-3">No matching tasks</h5>
      <p class="text-muted">Try adjusting your search or filter</p>
      <button class="btn btn-outline-primary" (click)="setStatusFilter('all'); clearSearch()">
        Clear Filters
      </button>
    </div>

    <!-- Task List -->
    <div *ngIf="filteredTasks().length > 0" class="task-list">
      <div
        *ngFor="let task of filteredTasks()"
        class="card mb-3 task-card"
        [class.border-danger]="isTaskOverdue(task)"
        [class.task-done]="task.status === TaskStatus.DONE">
        <div class="card-body">
          <div class="d-flex align-items-start justify-content-between">
            <div class="flex-grow-1">
              <!-- Status and Priority Badges -->
              <div class="d-flex align-items-center gap-2 mb-2">
                <span class="badge" [ngClass]="getTaskStatusBadgeClass(task.status)">
                  {{ task.status === 'in_progress' ? 'In Progress' : (task.status | titlecase) }}
                </span>
                <span class="badge" [ngClass]="getTaskPriorityBadgeClass(task.priority)">
                  {{ task.priority | titlecase }} Priority
                </span>
                <span *ngIf="task.isAiGenerated" class="badge bg-info" title="AI Generated from meeting">
                  <i class="bi bi-robot me-1"></i> AI Generated
                </span>
              </div>

              <!-- Title -->
              <h5 class="mb-2" [class.text-decoration-line-through]="task.status === TaskStatus.DONE">
                {{ task.title }}
              </h5>

              <!-- Description -->
              <p *ngIf="task.description" class="text-muted mb-2">{{ task.description }}</p>

              <!-- Meta Info -->
              <div class="d-flex flex-wrap align-items-center gap-3 text-muted small">
                <span *ngIf="task.dueDate" [class.text-danger]="isTaskOverdue(task)">
                  <i class="bi bi-calendar me-1"></i>
                  Due: {{ formatDueDate(task.dueDate) }}
                  <span *ngIf="isTaskOverdue(task)" class="fw-bold">(Overdue)</span>
                </span>
                <span>
                  <i class="bi bi-camera-video me-1"></i>
                  <a href="javascript:void(0)" (click)="viewMeeting(task.meetingId)" class="text-decoration-none">
                    View Meeting
                  </a>
                </span>
              </div>
            </div>

            <!-- Actions -->
            <div class="d-flex gap-2 ms-3">
              <!-- Quick Status Actions -->
              <div class="btn-group" role="group">
                <button
                  *ngIf="task.status !== TaskStatus.TODO"
                  class="btn btn-sm btn-outline-secondary"
                  (click)="updateTaskStatus(task, TaskStatus.TODO)"
                  title="Mark as To Do">
                  <i class="bi bi-circle"></i>
                </button>
                <button
                  *ngIf="task.status !== TaskStatus.IN_PROGRESS"
                  class="btn btn-sm btn-outline-primary"
                  (click)="updateTaskStatus(task, TaskStatus.IN_PROGRESS)"
                  title="Mark as In Progress">
                  <i class="bi bi-play-circle"></i>
                </button>
                <button
                  *ngIf="task.status !== TaskStatus.DONE"
                  class="btn btn-sm btn-outline-success"
                  (click)="updateTaskStatus(task, TaskStatus.DONE)"
                  title="Mark as Done">
                  <i class="bi bi-check-circle"></i>
                </button>
              </div>

              <!-- Delete Button -->
              <button
                class="btn btn-sm btn-outline-danger"
                (click)="deleteTask(task)"
                title="Delete task">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
